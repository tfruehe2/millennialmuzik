{% load staticfiles %}

{% for post in post_list %}
  {% include "snippets/post_cells.html" %}
{% endfor %}

{% if is_paginated %}
<ul class="pagination">
  {% if page_obj.has_previous %}
    <li><a href="{{ newurl }}?page={{ page_obj.previous_page_number }}">&laquo;</a></li>
  {% else %}
    <li class="disabled"><span>&laquo;</span></li>
  {% endif %}
  {% for i in paginator.page_range %}
    {% if page_obj.number == i %}
      <li class="active"><span>{{ i }} <span class="sr-only">(current)</span></span></li>
    {% else %}
      <li><a href="{{ newurl }}?page={{ i }}">{{ i }}</a></li>
    {% endif %}
  {% endfor %}
  {% if page_obj.has_next %}
    <li><a href="{{ newurl }}?page={{ page_obj.next_page_number }}">&raquo;</a></li>
  {% else %}
    <li class="disabled"><span>&raquo;</span></li>
  {% endif %}
</ul>
{% endif %}

<script src="{% static 'blog/music_cell_buttons.js' %}"></script>
<script>
if ($(window).width() <= 1170) {
  $('#wrapper').addClass('toggled-2');
} else {
  $('#wrapper').removeClass('toggled-2');
}

$(window).resize(function() {
  if ($(window).width() <= 1170) {
    $('#wrapper').addClass('toggled-2');
  } else {
    $('#wrapper').removeClass('toggled-2');
  }
});

$(".search-button").click(function(e) {
  var $this = $(this);
  $("i", this).toggleClass("fa-search fa-times");

  $this
    .closest("li")
    .prev()
    .find('form.navbar-form')
    .fadeToggle('normal');
});

$(".signin-prompt").popover({
  trigger: "focus",
  html: true
})

</script>

<script>
$(function () {
  $('[data-toggle="tooltip"]').tooltip()
})

$("button.twitter-button").hover(function(e){
  e.preventDefault();
  $(this)
      .find('img')
      .prop("src", "{% static "blog/icons/Twitter_Logo_Blue.png" %}");
},
function(e){
  e.preventDefault();
  $(this)
      .find('img')
      .prop("src", "{% static "blog/icons/Twitter_Logo_grey.png" %}");
});

$("button.fb-button").click(function(){
  $this = $(this);
  FB.ui({
    method: 'share',
    display: 'popup',
    href: $this.attr('data-url'),
  }, function(response){});
});


$( "button.like-button" ).click(function(e) {
  e.preventDefault();
  var $this = $(this);
  $('i', this).toggleClass("fa-heart-o fa-heart");

  $.ajax({
    url: "{% url "blog:add_like" %}",
    type: 'POST',
    data: {'post_id': $this.attr('data-id')},
    success: function(json) {
      if ($this.has('span')) {
        $this.find('strong').text("  "+json.num_likes)
      }
    },
    error: function(error) {
      console.log("failed to like post");
    },
  });
});


</script>
<script>
$('.lyrics-button').click(function(e){
  e.preventDefault();
  var $this = $(this)
    $this
      .closest('div.col-sm-4')
      .find('.panel-body')
      .hide()
      .next('.text-scroller')
      .removeClass('hidden');
    $this.remove()
});
</script>
{% if user.is_authenticated %}
<script>
$('.playlist-button').click(function(e){
  e.preventDefault();
  var name = $(this).attr('data-song-name');
  var songID = $(this).attr('data-song-id');
  var urlString = '/create_playlist/'+songID+'/'
  console.log(urlString)
  $('#playlistForm, #playlistModal').attr('action', urlString)

  $('#songName', "#playlistModal")
      .text("Song to be added: "+name);
  $('#playlistModal')
      .attr('data-song-id', songID)
      .modal('show');

});

$('#playlistImage').change(function(){
  var re = new RegExp("^(image/.{3,4})$")
  var file = this.files[0]
  if (!re.test(file.type)) {
    alert('Sorry, the file you added was not an image!');
    $(this).val("");
  }
  else if (file.size >= 2000000) {
    alert('Sorry, your image file is too big!\n2Mbs is the cutoff')
    $(this).val('');
  }
});

$('#submitPlaylist').click(function(e) {
  console.log('clicked')
  e.preventDefault();
  var form = $('#playlistForm, #playlistModal').serialize()

  $.ajax({
    url: $('#playlistForm, #playlistModal').attr('action'),
    type: "POST",
    data: form,
    dataType: 'json',
    success: function(data) {
      if (data.e) {
        console.log(data.e)
        if(data.name != ""){
            $("#playlistName",'#playlistForm').val(data.name);
            $('#nameError', "#playlistForm").hide()
        } else {
              $('#nameError', "#playlistForm").show()
        }
        if(data.description != ""){
            $("#playlistDescription",'#playlistForm').val(data.description);
            $('#descriptionError', "#playlistForm").hide()

        } else {
            $('#descriptionError', "#playlistForm").show()
        }
      } else {
        $('#closeModal', "#playlistModal").trigger('click')
        location.reload();
      }
    },
    error: function() {
      console.log('failed to create playlist');
    }
  })

});

$('#addToPlaylistBtn').click(function(e) {
  e.preventDefault();
  var playlist_id = $('#playlistButtonGroup > .active', '#playlistModal').attr('data-playlist-id')
  var song_id = $("#playlistModal").attr('data-song-id')
  console.log(playlist_id)
  if (playlist_id) {
    $('#addToPlaylistError').hide()
  $.ajax({
    url: "{% url 'blog:add_to_playlist' %}",
    type: "POST",
    data: {playlist_id: $('#playlistButtonGroup > .active', '#playlistModal').attr('data-playlist-id'),
            song_id: $("#playlistModal").attr('data-song-id')},
    success: function() {
      $('#closeModal', "#playlistModal").trigger('click')
    },
    error: function() {

    },
  });
} else {
  $('#addToPlaylistError').show()
}
});


$('#playlistModalBtnGroup').click(function(e) {
  e.preventDefault();
  if (!$(e.target).hasClass('active')) {
    $(e.target)
    .addClass('active')
    .trigger('updateModalBody')
    .siblings()
    .removeClass("active");
  }

});


$('#createPlaylist').on('updateModalBody', function(e) {
  console.log('create playlist clicked')
  $('#submitPlaylist')
      .text('Create Playlist')
      .removeClass('add')
      .addClass('create');
  $('#playlistList').empty()
  $('#modalForm', '#playlistModal').toggle()
  $("#createPlaylistBtn").toggle()
  $('#addToPlaylistBtn').hide()

})
$('#addToPlaylist').on('updateModalBody', function(e) {
  console.log('AddTo playlist clicked')
  $('#modalForm', '#playlistModal').hide()
  $("#createPlaylistBtn").hide()
  $('#addToPlaylistBtn').toggle()
  $.ajax({
    url: "{% url "blog:user_playlists" pk=user.pk %}",
    type: "GET",
    success: function(data) {
      $('#playlistList', '#playlistModal').html(data)

    },
    error: function() {
      console.log('failed to retrieve users playlists');
    }
  });
});

</script>
{% endif %}
